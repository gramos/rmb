#!/usr/bin/env ruby

help =  <<EOS
RMB(1)

NAME

    rmb -- Rubygems mirror benchmarks

SYNOPSYS

    rmb gem_name [sources]

DESCRIPTION


EOS

require 'benchmark'
require 'fileutils'

gem_name = 'rails'
sources  = %w(http://localhost:9292 https://rubygems.org/)

puts '----------------------- RMB -----------------------'

sources.each do |s|
  env             = ENV.to_hash
  gs_dir          = Dir.pwd + '/.gs/'
  env["GEM_HOME"] = gs_dir
  env["GEM_PATH"] = gs_dir

  FileUtils.rm_r gs_dir if File.directory? gs_dir
  FileUtils.mkdir gs_dir

  existing_sources = `gem sources`.split("\n").grep /http/

  existing_sources.each do |source|
   puts "=> Removing #{source} from rubygems sources..."
   system env, "gem sources -r #{source}"
  end

  puts "=> Adding #{s} to sources"
  system env, "gem source --add #{s}"

  puts "=> Starting installing #{gem_name} from: #{s}"

  bench = Benchmark.measure { system env, "gem install #{gem_name} --no-rdoc --no-ri" }
  puts "#{bench}\n"
end
